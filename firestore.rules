rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection: A user can read/write ONLY their own document
    match /users/{userId} {
      allow read, delete: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
      // Allow updates, but prevent direct modification of credits field from client
      allow update: if request.auth != null && 
                      request.auth.uid == userId &&
                      (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['credits']));

    // Trips collection: Users can create trips, read/update trips they own or collaborate on, only owner can delete
    match /trips/{tripId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid in resource.data.get('collaborators', [])
      );
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        request.auth.uid in resource.data.get('collaborators', [])
      );
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;

        // Days subcollection: Collaborators can read/write days for trips they collaborate on
        match /days/{dayId} {
            allow read, write: if request.auth != null && (
              get(/databases/$(database)/documents/trips/$(tripId)).data.userId == request.auth.uid ||
              request.auth.uid in get(/databases/$(database)/documents/trips/$(tripId)).data.get('collaborators', [])
            );
        }

        // Todos subcollection: Collaborators can read/write todos for trips they collaborate on
        match /todos/{todoId} {
            allow read, write: if request.auth != null && (
              get(/databases/$(database)/documents/trips/$(tripId)).data.userId == request.auth.uid ||
              request.auth.uid in get(/databases/$(database)/documents/trips/$(tripId)).data.get('collaborators', [])
            );
        }
    }

    // Places collection: Public read access, no client-side writes
    match /places/{placeId} {
        allow read: if request.auth != null;
        allow write: if false; // Disable client-side writes completely
    }

    // Public trips collection: Public read access, only admin SDK can write
    match /public_trips/{publicTripId} {
        allow read: if true; // Public read access
        allow write: if false; // Only admin SDK can write
    }
  }
}